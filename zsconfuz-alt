#!/bin/bash

# This program has almost the same interface as zsconfuz
#   (it only lacks the capability to dynamically add commands to the command queue)
#   and simulates it using ninja
# (C) 2019 Erik Zscheile
# License: ISC

IS_VERBOSE=false IS_RESUME=false

while [ $# -gt 1 ]; do
  case "$1" in
    (--resume)  IS_RESUME=true ;;
    (--verbose) IS_VERBOSE=true; NINJAOPTS+=" -v" ;;
    (*)         NINJAOPTS+=" $1" ;;
  esac
  shift
done

if ! [ -f "$1" ]; then
cat <<EOF
USAGE: zsconfuz-alt [--verbose] [-jN] [--resume] [NINJAOPTS] ZSconfuz-file.txt
NOTE: this program lacks the capability to dynamically add commands to the command queue
Options:
  -jN         use N workers
  --verbose   print executed commands
  --resume    (specific to zsconfuz-alt) keep temporary files
EOF
  exit 1
fi

cleanup() {
  "$IS_RESUME" || rm -rf "$(readlink .zscfzFiles)" .zscfzFiles .ninja_*
}

prnx() {
  "$IS_VERBOSE" && echo "$@" || true
  "$@"
}

trap cleanup EXIT
export PATH="$(dirname "$0")/../libexec/zsconfuz-alt:$PATH" NINJA_STATUS_SLEEP=inf
if ! "$IS_RESUME"; then
  TMPD="$(mktemp -d)"
  [ $? -eq 0 ] || exit 1
  rm -rf .zscfzFiles && ln -sT "$TMPD" .zscfzFiles || { rm -rf "$TMPD"; exit 1; }
  unset TMPD
else
  mkdir -p .zscfzFiles
fi

set -e
cp -f "$1" .zscfzFiles/zscfz.txt
"$IS_VERBOSE" && echo zscfz2ninja || true
zscfz2ninja < .zscfzFiles/zscfz.txt > .zscfzFiles/build.ninja
while true; do
  rm -f .zscfzFiles/zscfz2.txt && touch .zscfzFiles/zscfz2.txt || true
  prnx ninja -C .zscfzFiles $NINJAOPTS
  [ -s .zscfzFiles/zscfz2.txt ] || break
  (
    echo
    echo ": \"\""
    cat .zscfzFiles/zscfz2.txt
  ) >> .zscfzFiles/zscfz.txt
  "$IS_VERBOSE" && echo zscfz2ninja || true
  zscfz2ninja < .zscfzFiles/zscfz.txt > .zscfzFiles/build.ninja
done
